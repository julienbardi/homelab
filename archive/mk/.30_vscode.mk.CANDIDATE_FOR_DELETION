# ======================================================================
# VS Code Server via Caddy (HTTPS, selectable mTLS or Basic Auth)
# Role: Deploy code-server localhost service and publish code.bardi.ch
# Safety: Atomic installs, validation previews, graceful reloads
# ======================================================================

.PHONY: vscode-install vscode-unit-deploy vscode-service-start \
		caddy-mode-mtls caddy-mode-basic caddy-validate caddy-deploy \
		vscode-check caddy-preview caddy-bcrypt

# ----- Variables (override via environment or parent Makefile) -----
VS_USER        ?= julie
VS_HOME        ?= /home/$(VS_USER)
VS_UNIT_SRC    ?= $(VS_HOME)/homelab/10.89.12.4/etc/systemd/code-server.service
VS_UNIT_DST    ?= /etc/systemd/system/code-server.service

CADDY_SRC      ?= $(VS_HOME)/homelab/10.89.12.4/etc/caddy/Caddyfile
CADDY_DST      ?= /etc/caddy/Caddyfile
CODE_SNIPPET_MTLS  ?= $(VS_HOME)/homelab/templates/caddy/code_mtls.caddy
CODE_SNIPPET_BASIC ?= $(VS_HOME)/homelab/templates/caddy/code_basic.caddy
CADDY_WORK     ?= /tmp/caddy-work.$$  # ephemeral staging

VSCODE_HOST    ?= code.bardi.ch
BASIC_AUTH_USER ?= julien
BASIC_AUTH_HASH ?= # set via make caddy-bcrypt or environment

# ----- Install code-server (upstream script) -----
vscode-install:
	@echo "[VSCode] Installing code-server..."
	@curl -fsSL https://code-server.dev/install.sh | sh
	@echo "[VSCode] Installed: $$(code-server --version)"

# ----- Deploy systemd unit -----
vscode-unit-deploy:
	@echo "[VSCode] Deploy unit -> $(VS_UNIT_DST)"
	@sudo install -m 644 "$(VS_UNIT_SRC)" "$(VS_UNIT_DST)"
	@sudo systemctl daemon-reload

# ----- Start/enable service and verify localhost bind -----
vscode-service-start:
	@echo "[VSCode] Enable & start service"
	@sudo systemctl enable --now code-server.service
	@sudo systemctl is-active --quiet code-server.service && echo "[VSCode] service: active" || (echo "[VSCode] service: inactive"; exit 1)
	@ss -ltnp | grep -q '127.0.0.1:8080' && echo "[VSCode] bind: 127.0.0.1:8080" || (echo "[VSCode] bind: NOT localhost"; exit 1)

# ----- Produce a preview Caddyfile with selected mode -----
caddy-preview:
	@echo "[Caddy] Staging preview at $(CADDY_WORK)"
	@rm -rf "$(CADDY_WORK)"; mkdir -p "$(CADDY_WORK)"
	@cp "$(CADDY_SRC)" "$(CADDY_WORK)/Caddyfile"
	@echo "[Caddy] Appending VSCode route: $(VSCODE_HOST)"
	@printf "\n# --- VSCode route (generated) ---\n" >> "$(CADDY_WORK)/Caddyfile"
	@cat "$(CODE_SNIPPET)" | sed "s/\$$\{BASIC_AUTH_HASH\}/$(BASIC_AUTH_HASH)/g" >> "$(CADDY_WORK)/Caddyfile"
	@echo "[Caddy] Updating unknown fallback to include $(VSCODE_HOST)"
	@sed -i 's/\(@unknown not host .* \)/\1 $(VSCODE_HOST)/' "$(CADDY_WORK)/Caddyfile"
	@sudo caddy fmt --overwrite "$(CADDY_WORK)/Caddyfile"
	@sudo caddy validate --config "$(CADDY_WORK)/Caddyfile"
	@echo "[Caddy] Preview OK -> $(CADDY_WORK)/Caddyfile"
	@echo "[Caddy] Diff vs deployed (if exists):"
	@diff -u "$(CADDY_DST)" "$(CADDY_WORK)/Caddyfile" || true

# ----- Select mode: mTLS -----
caddy-mode-mtls: CODE_SNIPPET := $(CODE_SNIPPET_MTLS)
caddy-mode-mtls: caddy-preview
	@echo "[Caddy] Mode: mTLS"


# ----- Select mode: Basic Auth -----
caddy-mode-basic: CODE_SNIPPET := $(CODE_SNIPPET_BASIC)
caddy-mode-basic: caddy-preview
	@test -n "$(BASIC_AUTH_HASH)" || (echo "[ERR] BASIC_AUTH_HASH is empty. Run: make caddy-bcrypt PW=yourpassword"; exit 1)
	@echo "[Caddy] Mode: Basic Auth (user=$(BASIC_AUTH_USER))"

# ----- Deploy staged Caddyfile and reload -----
caddy-deploy:
	@test -d "$(CADDY_WORK)" || (echo "[ERR] No preview staged. Run caddy-mode-* first."; exit 1)
	@echo "[Caddy] Deploy -> $(CADDY_DST)"
	@sudo install -m 644 "$(CADDY_WORK)/Caddyfile" "$(CADDY_DST)"
	@sudo caddy reload --config "$(CADDY_DST)" || sudo systemctl reload caddy
	@echo "[Caddy] Reloaded"

# ----- Check HTTPS reachability -----
vscode-check:
	@echo "[Check] https://$(VSCODE_HOST)"
	@curl -sSf "https://$(VSCODE_HOST)" >/dev/null && echo "[OK] $(VSCODE_HOST)" || (echo "[ERR] cannot reach $(VSCODE_HOST)"; exit 1)

# ----- Helper: create bcrypt hash for Basic Auth -----
caddy-bcrypt:
	@test -n "$(PW)" || (echo "[ERR] Provide password via PW=..."; exit 1)
	@echo "[Caddy] Generating bcrypt hash..."
	@HASH=$$(caddy hash-password --algorithm bcrypt --plaintext "$(PW)"); echo "BASIC_AUTH_HASH=$$HASH"
	@echo "Export BASIC_AUTH_HASH or pass it to make: make caddy-mode-basic BASIC_AUTH_HASH=$$HASH"
