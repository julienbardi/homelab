#!/bin/sh
# /jffs/scripts/services-start
#
# Router responsibilities:
#   - Management plane access control (SSH, Web UI)
#   - Policy routing safety for LAN
#   - No overlay networks, no identity, no control planes
#
# Source of truth: explicit, idempotent firewall invariants
#

/bin/sh /jffs/addons/amtm/shell_history.mod -run
/bin/sh /jffs/addons/amtm/sc_update.mod -set
[ -x /jffs/scripts/MerlinAU.sh ] && /jffs/scripts/MerlinAU.sh startup "$@" & #MerlinAU#

#
# --- SSH access control ---
#

# LAN safety net (always allow SSH from LAN)
LAN_SSH_RULE="-p tcp -s 10.89.12.0/24 --dport 2222 -j ACCEPT"
iptables -C INPUT $LAN_SSH_RULE 2>/dev/null || iptables -I INPUT $LAN_SSH_RULE

# Controlled SSH access via VPNs
ipset create ssh_allowed hash:net -exist

ipset add ssh_allowed 10.89.13.0/24   -exist   # WireGuard clients

SSH_RULE="-p tcp -m set --match-set ssh_allowed src --dport 2222 -j ACCEPT"
iptables -C INPUT $SSH_RULE 2>/dev/null || iptables -I INPUT $SSH_RULE

#
# --- Router Web UI access ---
#

# Allow Web UI from WireGuard (IPv4)
WEBUI_RULE="-p tcp -s 10.89.13.0/24 --dport 8080 -j ACCEPT"
iptables -C INPUT $WEBUI_RULE 2>/dev/null || iptables -I INPUT $WEBUI_RULE

# Allow Web UI from WireGuard (IPv6 ULA)
WEBUI6_RULE="-p tcp -s fd89:7a3b:42c0:13::/64 --dport 8080 -j ACCEPT"
ip6tables -C INPUT $WEBUI6_RULE 2>/dev/null || ip6tables -I INPUT $WEBUI6_RULE

#
# --- Policy routing safety ---
#

# Ensure router-originated LAN traffic never enters VPN routing
ip rule del from 10.89.12.0/24 lookup main 2>/dev/null || true
ip rule add from 10.89.12.0/24 lookup main

# --- Allow routing between WG subnets 10.89.13.0/24 and 10.89.12.0/24 ---
# Accept forward traffic in both directions
iptables      -C FORWARD -s 10.89.13.0/24 -d 10.89.12.0/24 -j ACCEPT 2>/dev/null \
  || iptables -A FORWARD -s 10.89.13.0/24 -d 10.89.12.0/24 -j ACCEPT

iptables      -C FORWARD -s 10.89.12.0/24 -d 10.89.13.0/24 -j ACCEPT 2>/dev/null \
  || iptables -A FORWARD -s 10.89.12.0/24 -d 10.89.13.0/24 -j ACCEPT

# NAT only if 10.89.12.x hosts do NOT know how to route back to 10.89.13.0/24
iptables      -t nat -C POSTROUTING -s 10.89.13.0/24 -d 10.89.12.0/24 -j MASQUERADE 2>/dev/null \
  || iptables -t nat -A POSTROUTING -s 10.89.13.0/24 -d 10.89.12.0/24 -j MASQUERADE

# NAT WireGuard clients to WAN for fullâ€‘tunnel internet access
iptables      -t nat -C POSTROUTING -s 10.89.13.0/24 -o eth0 -j MASQUERADE 2>/dev/null \
  || iptables -t nat -A POSTROUTING -s 10.89.13.0/24 -o eth0 -j MASQUERADE

#
# --- DNS backend health check ---
#

[ -x /jffs/scripts/dns-health ] && /jffs/scripts/dns-health &
[ -f /jffs/scripts/MerlinAU.sh ] && sh /jffs/scripts/MerlinAU.sh addCronJob &

