# ------------------------------------------------------------
# a) CNAMEs to define
#    - vpn.bardi.ch      → CNAME to bardi.ch   (Headscale control plane, proxied internally)
#    - derp.vpn.bardi.ch → CNAME to bardi.ch   (Headscale DERP relay, exposed externally)
#    - bardi.ch          → A record or CNAME to your dynamic DNS (jam9.synology.me)
#    - www.bardi.ch      → not needed in your setup
#    - WireGuard (wg0–wg7) → no extra CNAMEs required; clients use vpn.bardi.ch + port
#
# b) Ports to forward
#    Forward to DiskStation (10.89.12.2):
#      - 5001 (DSM management HTTPS)
#      - 5006 (Synology service)
#      - 6690 (Synology Drive)
#
#    Forward to Headscale host (10.89.12.4):
#      - 8912 (Headscale DERP relay, exposed externally)
#      - 3478 (UDP STUN/DERP for NAT traversal)
#      - 51420–51427 (UDP, WireGuard wg0–wg7 interfaces)
#      - 80   (HTTP, for Let's Encrypt renewal)
#      - 443  (HTTPS, DSM / DiskStation services)
#
#    DO NOT forward 8910 externally:
#      - Reason: 8910 is the Headscale API. Exposing it directly increases attack surface.
#        Instead, clients connect via vpn.bardi.ch on 443, with Caddy proxying internally.
#
# c) WireGuard VPN (wg0–wg7 on 51420–51427 UDP)
#    - No extra CNAMEs are needed: WireGuard clients connect directly to your public IP + port.
#    - You can use vpn.bardi.ch as the hostname for convenience:
#        wg0 → udp://vpn.bardi.ch:51420
#        wg1 → udp://vpn.bardi.ch:51421
#        ...
#        wg7 → udp://vpn.bardi.ch:51427
# ------------------------------------------------------------

# HTTP port for Let's Encrypt renewal
bardi.ch:80 {
	reverse_proxy 10.89.12.2:80
}

# Syncthing GUI
bardi.ch:8384 {
	reverse_proxy 10.89.12.2:8384
}

# Consolidated HTTPS listener
:443 {
	tls /etc/ssl/caddy/fullchain.pem /etc/ssl/caddy/privkey.pem

	# DiskStation main HTTPS site (WAN)
	@bardi_internal {
		host bardi.ch
	}
	reverse_proxy @bardi_internal 10.89.12.2:443 {
		header_up Host bardi.ch
	}

	# DSM management (internal only)
	@syno5001_internal {
		host bardi.ch
		remote_ip 10.89.12.0/24
		remote_ip 2a01:8b81:4800:9c00::/64
	}
	reverse_proxy @syno5001_internal 10.89.12.2:5001 {
		header_up Host bardi.ch
	}

	# Synology service (internal only)
	@syno5006_internal {
		host bardi.ch
		remote_ip 10.89.12.0/24
		remote_ip 2a01:8b81:4800:9c00::/64
	}
	reverse_proxy @syno5006_internal 10.89.12.2:5006 {
		header_up Host bardi.ch
	}

	# Synology Drive (internal only)
	@syno6690_internal {
		host bardi.ch
		remote_ip 10.89.12.0/24
		remote_ip 2a01:8b81:4800:9c00::/64
	}
	reverse_proxy @syno6690_internal 10.89.12.2:6690 {
		header_up Host bardi.ch
	}

	# Router (internal only)
	@router_internal {
		host router.bardi.ch
		remote_ip 10.89.12.0/24
		remote_ip 2a01:8b81:4800:9c00::/64
	}
	reverse_proxy @router_internal 10.89.12.1:8080

	# DNS over HTTPS (DoH) → dnsdist backend
	@doh {
		host dns.bardi.ch
		path /dns-query
	}
	reverse_proxy @doh https://127.0.0.1:8443 {
		transport http {
			tls
			tls_insecure_skip_verify
		}
	}

	# Headscale control plane (external clients allowed)
	@vpn {
		host vpn.bardi.ch
	}
	reverse_proxy @vpn 127.0.0.1:8910 {
		header_up Host vpn.bardi.ch
		transport http {
			versions h2c
			keepalive 5s
		}
		flush_interval 1s
	}

	# DERP relay (external)
	@derp host derp.bardi.ch
	reverse_proxy @derp 127.0.0.1:8912

	# QNAP (internal only)
	@qnap_internal {
		host qnap.bardi.ch
		remote_ip 10.89.12.0/24
		remote_ip 2a01:8b81:4800:9c00::/64
	}
	reverse_proxy @qnap_internal 10.89.12.3:8080

	# NAS internal service (internal only)
	@nas_internal {
		host nas.bardi.ch
		remote_ip 10.89.12.0/24
		remote_ip 2a01:8b81:4800:9c00::/64
	}
	reverse_proxy @nas_internal 127.0.0.1:9999

	# Dev IDE (internal only)
	@dev_internal {
		host dev.bardi.ch

		# LAN IPv4 + IPv6
		remote_ip 10.89.12.0/24
		remote_ip 2a01:8b81:4800:9c00::/64

		# WireGuard IPv4 subnets (wg0–wg7)
		remote_ip 10.0.0.0/24
		remote_ip 10.1.0.0/24
		remote_ip 10.2.0.0/24
		remote_ip 10.3.0.0/24
		remote_ip 10.4.0.0/24
		remote_ip 10.5.0.0/24
		remote_ip 10.6.0.0/24
		remote_ip 10.7.0.0/24

		# WireGuard IPv6 /128s
		remote_ip 2a01:8b81:4800:9c00:10::1/128
		remote_ip 2a01:8b81:4800:9c00:11::1/128
		remote_ip 2a01:8b81:4800:9c00:12::1/128
		remote_ip 2a01:8b81:4800:9c00:13::1/128
		remote_ip 2a01:8b81:4800:9c00:14::1/128
		remote_ip 2a01:8b81:4800:9c00:15::1/128
		remote_ip 2a01:8b81:4800:9c00:16::1/128
		remote_ip 2a01:8b81:4800:9c00:17::1/128

		# Tailscale CGNAT range
		remote_ip 100.64.0.0/10
	}
	reverse_proxy @dev_internal 127.0.0.1:8080 {
		header_up Host dev.bardi.ch
	}

	# Unknown host fallback
	@unknown not host bardi.ch router.bardi.ch dns.bardi.ch vpn.bardi.ch derp.bardi.ch qnap.bardi.ch nas.bardi.ch dev.bardi.ch
	respond @unknown "Not Found" 404

	# log disabled to avoid disk spin
}
# After modification run
# 1. Check the config first (dry run):
#    sudo caddy validate --config /home/julie/src/homelab/config/caddy/Caddyfile
#    sudo caddy fmt --overwrite   /home/julie/src/homelab/config/caddy/Caddyfile
# 2. Deploy the file
#    sudo cp /home/julie/src/homelab/config/caddy/Caddyfile /etc/caddy/Caddyfile
# 3. Reload gracefully:
#    sudo caddy reload --config /etc/caddy/Caddyfile
# 4. If running as a systemd service:
#    sudo systemctl reload caddy
# Don’t use systemctl restart caddy unless you want a hard restart — that will drop connections.
# Don’t kill the process manually; you’ll interrupt traffic.
