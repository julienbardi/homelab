# /etc/unbound/unbound.conf
#
# Purpose:
#   Recursive DNS resolver backend for the homelab.
#   - Listens on localhost for local resolvers (dnsmasq, systemd-resolved)
#   - Listens on LAN IP for the router only
#   - Provides validated, DNSSEC-aware recursion
#
# Deployment procedure:
#   sudo unbound-checkconf /home/julie/src/homelab/config/unbound/unbound.conf
#   sudo install -o root -g root -m 0644 /home/julie/src/homelab/config/unbound/unbound.conf /etc/unbound/unbound.conf
#   sudo systemctl restart unbound
#
# One-time setup:
#   sudo systemctl enable unbound
#
# Verification:
#   sudo systemctl status unbound
#   sudo journalctl -u unbound -f

server:
    # Listen on loopback for local DNS frontends
    interface: 127.0.0.1
    interface: ::1

    # Listen on LAN IP for router-only recursion
    interface: 10.89.12.4

    # Allow outbound queries via any interface (IPv4 and IPv6)
    outgoing-interface: 0.0.0.0
    outgoing-interface: ::

    # Backend resolver port (dnsmasq forwards here)
    port: 5335

    # Prefer IPv6 when available, but support both stacks
    do-ip6: yes
    prefer-ip6: yes

    # Run as unprivileged user
    username: "unbound"
    pidfile: ""
    do-daemonize: no

    # Local override for Headscale DERP endpoint
    # Prevents recursion and enforces split-horizon behavior
    local-data: "derp.vpn.bardi.ch. A 127.0.0.1"

    # Enable DNSSEC validation and iterative resolution
    module-config: "validator iterator"

    # Allow querying localhost (required for local resolvers)
    do-not-query-localhost: no

    # DNSSEC trust anchor and root hints
    auto-trust-anchor-file: "/var/lib/unbound/root.key"
    val-permissive-mode: no
    root-hints: "/var/lib/unbound/root.hints"

    # ------------------------------------------------------------
    # Access control
    # ------------------------------------------------------------
    # Access control model:
    # - Unbound is not a client-facing resolver.
    # - Only local resolvers (dnsmasq, systemd-resolved) and the router
    #   are allowed to query Unbound directly.
    # - WireGuard and Tailscale clients never reach Unbound; they send DNS
    #   to the router, which forwards queries on their behalf.
    # - Therefore, no explicit access-control entries are required for
    #   WireGuard or Tailscale address ranges.

    # Allow local processes (dnsmasq, systemd-resolved, diagnostics)
    access-control: 127.0.0.1/32 allow
    access-control: ::1/128 allow
    access-control: 127.0.0.0/8 allow

    # Allow the NAS to query itself on its LAN IP
    access-control: 10.89.12.4/32 allow

    # Allow recursion from the router only
    access-control: 10.89.12.1/32 allow

    # Explicitly refuse all other LAN clients
    access-control: 10.89.12.0/24 refuse

    # ------------------------------------------------------------
    # Performance tuning (Optimized for 6-core Forwarding)
    # ------------------------------------------------------------
    # Matches your Intel Gold 8505 (5-cores used for Unbound)
    num-threads: 5

    # Use 4 or 8 slabs (must be power of 2). 8 is fine.
    msg-cache-slabs: 8
    rrset-cache-slabs: 8
    infra-cache-slabs: 8
    key-cache-slabs: 8

    # Cache sizing - These are excellent and plenty for 100k+
    msg-cache-size: 256m
    rrset-cache-size: 512m
    key-cache-size: 128m
    # To hold NXDOMAIN results from the 100k list
    neg-cache-size: 64m

    # Aggressive Use of DNSSEC NSEC records
    # This allows Unbound to synthesize NXDOMAINs for whole ranges
    # without querying upstream, saving massive amounts of time.
    aggressive-nsec: yes

    # Aggressive prefetching for latency reduction
    prefetch: yes
    prefetch-key: yes

    # Query concurrency limits
    outgoing-range: 8192
    num-queries-per-thread: 16384

    # Serve expired records while refreshing in background
    serve-expired: yes

    # Socket tuning
    so-reuseport: yes
    so-rcvbuf: 8m
    so-sndbuf: 8m

    # Privacy hardening
    hide-identity: yes
    hide-version: yes
    qname-minimisation: yes

    # Moderate verbosity for operational visibility
    verbosity: 2
    extended-statistics: yes

# ------------------------------------------------------------
# Authoritative-only resolution for bardi.ch
# ------------------------------------------------------------
# Delegate bardi.ch to its authoritative nameservers
# Prevents unnecessary recursion for local domain
stub-zone:
    name: "bardi.ch."
    stub-host: ns11.infomaniak.ch
    stub-host: ns12.infomaniak.ch

# ------------------------------------------------------------
# Recursive forwarding (enabled)
# ------------------------------------------------------------
# Unbound performs full recursion by default.
# Forwarding can be enabled here if upstream resolvers are desired.
#
forward-zone:
    name: "."

    # Cloudflare
    forward-addr: 1.1.1.1
    forward-addr: 1.0.0.1
    forward-addr: 2606:4700:4700::1111
    forward-addr: 2606:4700:4700::1001

    # Quad9
    forward-addr: 9.9.9.9
    forward-addr: 149.112.112.112
    forward-addr: 2620:fe::fe
    forward-addr: 2620:fe::9

    # Digitale Gesellschaft (CH)
    forward-addr: 185.95.218.42
    forward-addr: 185.95.218.43

# ------------------------------------------------------------
# Remote control interface
# ------------------------------------------------------------
# Enables unbound-control for runtime inspection and management
remote-control:
    control-enable: yes
    control-interface: /run/unbound.ctl
    server-key-file: /etc/unbound/unbound_server.key
    server-cert-file: /etc/unbound/unbound_server.pem
    control-key-file: /etc/unbound/unbound_control.key
    control-cert-file: /etc/unbound/unbound_control.pem
