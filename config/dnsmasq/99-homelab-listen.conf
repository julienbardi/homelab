# 99-homelab-listen.conf
#
# DNS + IPv6 RA frontend for VPN and local clients
# Forwards to local Unbound resolver with DNSSEC validation
# Provides IPv6 Router Advertisements for all WireGuard interfaces

# Disable DHCP lease storage (Ugreen OS has no /var/lib/misc)
dhcp-leasefile=/dev/null

# ------------------------------------------------------------
# Listening addresses (explicit and deterministic)
# ------------------------------------------------------------

# Let Ugreen dnsmasq listen on all IPv4 interfaces (default behavior)
# Do NOT specify listen-address=0.0.0.0 — Ugreen already binds it internally.

# Explicit IPv6 listener (safe and prefix‑agnostic)
#
# We bind dnsmasq only to ::1 for IPv6 because:
#   - Global IPv6 addresses on eth0 are dynamic (SLAAC + privacy extensions)
#   - The ISP‑delegated /56 prefix can change at any reboot or router update
#   - dnsmasq *fails hard* if a configured listen-address does not exist
#   - Binding to ::1 guarantees a stable, always-present IPv6 endpoint
#
# dnsmasq will still:
#   - Listen on all IPv4 interfaces (default Ugreen behavior)
#   - Serve IPv6 Router Advertisements on wg0–wg7 via interface=wgX
#   - Advertise per‑wgX DNS servers (::1 on each wgX)
#
# Never bind dnsmasq to a global IPv6 (e.g., 2a01:8b81:4800:9c00::4)
# unless the router supports static DHCPv6 reservations — most do not.
listen-address=::1

# Enforce interface binding
bind-interfaces

# DNS service port
port=53

# ------------------------------------------------------------
# Upstream resolver (Unbound)
# ------------------------------------------------------------

# Forward all queries to local Unbound
server=127.0.0.1#5335

# Preserve DNSSEC validation results (AD bit)
proxy-dnssec

# ------------------------------------------------------------
# Safety defaults
# ------------------------------------------------------------

# Never read /etc/resolv.conf
no-resolv

# Never pollute with DHCP DNS
no-poll

# Do not cache negative answers excessively
neg-ttl=60

# ------------------------------------------------------------
# IPv6 Router Advertisements for all WireGuard interfaces
# ------------------------------------------------------------
# Each wgX interface gets its own /64 from the delegated /56
# Clients receive:
#   - IPv6 address
#   - Default gateway (::1 on wgX)
#   - DNS server (::1 on wgX)
#   - Prefix lifetime + RA parameters

# -------------------------
# wg0 → 2a01:8b81:4800:9c01::/64
# -------------------------
interface-name=wg0,*
enable-ra
dhcp-range=::100,::1ff,constructor:wg0,ra-names,64
dhcp-option=option6:dns-server,[::1]

# -------------------------
# wg1 → 2a01:8b81:4800:9c02::/64
# -------------------------
interface-name=wg1,*
enable-ra
dhcp-range=::100,::1ff,constructor:wg1,ra-names,64
dhcp-option=option6:dns-server,[::1]

# -------------------------
# wg2 → 2a01:8b81:4800:9c03::/64
# -------------------------
interface-name=wg2,*
enable-ra
dhcp-range=::100,::1ff,constructor:wg2,ra-names,64
dhcp-option=option6:dns-server,[::1]

# -------------------------
# wg3 → 2a01:8b81:4800:9c04::/64
# -------------------------
interface-name=wg3,*
enable-ra
dhcp-range=::100,::1ff,constructor:wg3,ra-names,64
dhcp-option=option6:dns-server,[::1]

# -------------------------
# wg4 → 2a01:8b81:4800:9c05::/64
# -------------------------
interface-name=wg4,*
enable-ra
dhcp-range=::100,::1ff,constructor:wg4,ra-names,64
dhcp-option=option6:dns-server,[::1]

# -------------------------
# wg5 → 2a01:8b81:4800:9c06::/64
# -------------------------
interface-name=wg5,*
enable-ra
dhcp-range=::100,::1ff,constructor:wg5,ra-names,64
dhcp-option=option6:dns-server,[::1]

# -------------------------
# wg6 → 2a01:8b81:4800:9c07::/64
# -------------------------
interface-name=wg6,*
enable-ra
dhcp-range=::100,::1ff,constructor:wg6,ra-names,64
dhcp-option=option6:dns-server,[::1]

# -------------------------
# wg7 → 2a01:8b81:4800:9c08::/64
# -------------------------
interface-name=wg7,*
enable-ra
dhcp-range=::100,::1ff,constructor:wg7,ra-names,64
dhcp-option=option6:dns-server,[::1]
