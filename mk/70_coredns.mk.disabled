# mk/70_coredns.mk
# Idempotent Makefile fragment to build CoreDNS,
# install binary and Corefile, create runtime user, systemd unit and enable service.
# Depends on 'headscale' target which ensures the headscale source is present.

.ONESHELL:
SHELL := /bin/bash

# Paths and configuration
COREDNS_SRC ?= /home/julie/src/coredns-src
COREDNS_OUT ?= /home/julie/src/coredns
COREDNS_BIN := $(COREDNS_OUT)/coredns
COREFILE_SRC := /home/julie/src/homelab/config/coredns/Corefile
COREFILE_DEST := /etc/coredns/Corefile
PLUGINCFG_SRC := /home/julie/src/homelab/config/coredns/plugin.cfg
PLUGINCFG_DEST := $(COREDNS_SRC)/plugin.cfg

GIT_REPO ?= https://github.com/coredns/coredns.git
CORE_DNS_REF ?= origin/HEAD

HEADSCALE_REPO ?= https://github.com/juanfont/headscale.git
HEADSCALE_SRC ?= /home/julie/src/headscale

RUN_USER ?= coredns
SERVICE_NAME ?= coredns
SYSTEMD_UNIT := /etc/systemd/system/$(SERVICE_NAME).service
OVERWRITE_UNIT ?= 0

.PHONY: install-pkg-coredns headscale

install-pkg-coredns:
	@echo "ðŸ› ï¸ Building and installing CoreDNS..."
	set -euo pipefail

	# check prerequisites
	if ! command -v go >/dev/null 2>&1; then \
		echo "âŒ ERROR: 'go' not found in PATH; install Go and retry"; exit 1; \
	fi

	# clone or update CoreDNS source
	if [ ! -d "$(COREDNS_SRC)" ]; then \
		echo "ðŸ“¥ Cloning CoreDNS to $(COREDNS_SRC)"; \
		git clone --depth 1 "$(GIT_REPO)" "$(COREDNS_SRC)"; \
	else \
		echo "ðŸ”„ Updating CoreDNS at $(COREDNS_SRC)"; \
		git -C "$(COREDNS_SRC)" fetch --depth 1 origin && git -C "$(COREDNS_SRC)" reset --hard "$(CORE_DNS_REF)"; \
	fi

	# install curated plugin.cfg
	@echo "ðŸ“‘ Installing plugin.cfg from $(PLUGINCFG_SRC) -> $(PLUGINCFG_DEST)"
	sudo install -m 0644 "$(PLUGINCFG_SRC)" "$(PLUGINCFG_DEST)"

	# ensure Go uses SSH for GitHub
	git config --global url."git@github.com:".insteadOf "https://github.com/"

	# fetch module deps and build with xcaddy
	@echo "âš™ï¸ Running go generate + build"
	cd "$(COREDNS_SRC)" && go get github.com/coredns/doh
	cd "$(COREDNS_SRC)" && go mod tidy
	cd "$(COREDNS_SRC)" && make
	#@echo "âš™ï¸ Building CoreDNS with xcaddy"
	#xcaddy build --output "$(COREDNS_BIN)" --with github.com/coredns/doh --with github.com/coredns/prometheus

	# prepare runtime user and directories
	if ! id -u $(RUN_USER) >/dev/null 2>&1; then \
		echo "ðŸ‘¤ Creating runtime user $(RUN_USER)"; \
		sudo useradd --system --no-create-home --shell /usr/sbin/nologin $(RUN_USER) || true; \
	fi
	@echo "ðŸ“‚ Preparing /etc/coredns and /var/lib/coredns"
	sudo install -d -m 0755 -o $(RUN_USER) -g $(RUN_USER) /etc/coredns /var/lib/coredns || true

	# install Corefile
	@echo "ðŸ“‘ Installing Corefile from $(COREFILE_SRC) -> $(COREFILE_DEST)"
	sudo install -m 0644 -o $(RUN_USER) -g $(RUN_USER) "$(COREFILE_SRC)" "$(COREFILE_DEST)"

	# atomic backup of binary
	@echo "ðŸ’¾ Installing CoreDNS binary to $(COREDNS_BIN)"
	mkdir -p "$(COREDNS_OUT)"
	if [ -f "$(COREDNS_BIN)" ]; then sudo cp "$(COREDNS_BIN)" "$(COREDNS_BIN).bak" || true; fi
	# xcaddy already wrote the new binary to $(COREDNS_BIN)

	# create or overwrite systemd unit
	if [ ! -f "$(SYSTEMD_UNIT)" ] || [ "$(OVERWRITE_UNIT)" = "1" ]; then \
		echo "ðŸ“ Writing systemd unit to $(SYSTEMD_UNIT)"; \
		printf '%s\n' \
"[Unit]" \
"Description=CoreDNS" \
"After=network.target" \
"" \
"[Service]" \
"ExecStart=$(COREDNS_BIN) -conf /etc/coredns/Corefile" \
"WorkingDirectory=/etc/coredns" \
"User=$(RUN_USER)" \
"Group=$(RUN_USER)" \
"Restart=on-failure" \
"LimitNOFILE=65536" \
"" \
"[Install]" \
"WantedBy=multi-user.target" \
		| sudo tee "$(SYSTEMD_UNIT)" > /dev/null ; \
	else \
		echo "â„¹ï¸ systemd unit exists at $(SYSTEMD_UNIT); set OVERWRITE_UNIT=1 to replace"; \
	fi

	# enable and start service
	@echo "ðŸš€ Enabling and starting CoreDNS service"
	sudo systemctl daemon-reload
	sudo systemctl enable $(SERVICE_NAME) || true
	if sudo systemctl is-active --quiet $(SERVICE_NAME); then \
		sudo systemctl restart $(SERVICE_NAME) || true; \
	else \
		sudo systemctl start $(SERVICE_NAME) || true; \
	fi

	# verification hints
	"$(COREDNS_BIN)" -plugins | grep -E 'doh' >/dev/null 2>&1 || echo "âš ï¸ WARNING: built binary does not list doh in -plugins output"
	"$(COREDNS_BIN)" -conf /etc/coredns/Corefile >/dev/null 2>&1 || echo "âš ï¸ NOTE: Corefile parse failed; check /etc/coredns/Corefile and journalctl -u $(SERVICE_NAME)"

	@echo "âœ… install-pkg-coredns: done (binary -> $(COREDNS_BIN))"
